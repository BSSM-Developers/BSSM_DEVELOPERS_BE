name: Deploy BDV (proxmox-minimal)

on:
  push:
    branches: [ master ]     
  workflow_dispatch:

concurrency:
  group: deploy-${{ vars.SVC }}-prod
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  deploy:
    runs-on: [ self-hosted ]   

    env:
      CTID:     ${{ vars.CTID }}        
      SVC:      ${{ vars.SVC }}         
      APP_DIR:  ${{ vars.APP_DIR }}     
      JAR_NAME: ${{ vars.JAR_NAME || 'bdv.jar' }}   

    steps:
      - uses: actions/checkout@v4

      - name: Verify inputs (fail fast)
        run: |
          : "${CTID:?CTID is empty}"
          : "${SVC:?SVC is empty}"
          : "${APP_DIR:?APP_DIR is empty}"
          : "${JAR_NAME:?JAR_NAME is empty}"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Build (Gradle bootJar)
        run: |
          chmod +x ./gradlew
          ./gradlew clean bootJar --no-daemon

      - name: Locate built JAR
        id: jar
        run: |
          JAR_PATH=$(find . -type f -name "*.jar" -path "*/build/libs/*" | sort | tail -n 1)
          if [ -z "$JAR_PATH" ]; then
            echo "No JAR found under */build/libs/*"
            exit 1
          fi
          echo "jar_path=$JAR_PATH" >> $GITHUB_OUTPUT
          echo "Using: $JAR_PATH"

      - name: Push artifact to CT (only JAR)
        run: |
          sudo /usr/sbin/pct push "$CTID" "${{ steps.jar.outputs.jar_path }}" "/tmp/${JAR_NAME}"
          
      - name: Deploy inside CT & restart
        run: |
          sudo /usr/sbin/pct exec "$CTID" -- bash -lc "
            set -euo pipefail
      
            APP_DIR='${APP_DIR}'
            JAR_NAME='${JAR_NAME}'
            SRC=\"/tmp/\$JAR_NAME\"
            DST=\"\$APP_DIR/\$JAR_NAME\"
      
            install -d -m 755 \"\$APP_DIR\"
      
            if [ -f \"\$DST\" ]; then
              cp -f \"\$DST\" \"\$DST.bak\" || true
            fi
      
            cp \"\$SRC\" \"\$DST.tmp\"
            mv -f \"\$DST.tmp\" \"\$DST\"
            rm -f \"\$SRC\"
      
            chown bssm-dev:bssm-dev \"\$DST\"
            chmod 640 \"\$DST\"
      
            systemctl daemon-reload
            systemctl restart \"${SVC}.service\"
          "
